{% extends "base.html" %}
{% block content %}

<h2 id="hello">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>

<div id="content" style="display:none;">
  <div id="cabinet-list"></div>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
  const tg = window.Telegram.WebApp;
  tg.expand();

  const user = tg.initDataUnsafe?.user;
  if (!user) {
    document.getElementById("hello").innerText =
      "‚ö†Ô∏è –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ –≤–Ω–µ Telegram, –¥–∞–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.";
    return;
  }

  // –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
  document.getElementById("hello").innerText =
    "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, " + (user.first_name || user.username) + "!";

  // –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è / —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
  try {
    const resp = await fetch("/dashboard/api/login", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        telegram_id: user.id,
        name: user.first_name || user.username || "User"
      })
    });
    const data = await resp.json();
    if (data.ok) {
      document.getElementById("content").style.display = "block";
      loadCabinets(user.id);
    }
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:", e);
  }
});

async function loadCabinets(uid) {
  const res = await fetch(`/dashboard/api/user/${uid}`);
  const user = await res.json();
  const div = document.getElementById("cabinet-list");
  div.innerHTML = "";

  if (!user.cabinets || user.cabinets.length === 0) {
    div.innerHTML = "<p>–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∫–∞–±–∏–Ω–µ—Ç–æ–≤.</p>";
    return;
  }

  user.cabinets.forEach(cab => {
    const el = document.createElement("div");
    el.className = "cabinet-card";
    el.innerHTML = `
      <h4>${cab.name}</h4>
      <p>–°—Ç–∞—Ç—É—Å: ${
        cab.active ? '<span class="status-active">üü¢ –ê–∫—Ç–∏–≤–µ–Ω</span>'
                    : '<span class="status-inactive">üî¥ –û—Ç–∫–ª—é—á–µ–Ω</span>'
      }</p>
      <button class="btn-secondary" onclick="window.location.href='/dashboard/cabinet/${cab.id}'">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    `;
    div.appendChild(el);
  });
}
</script>

{% endblock %}
