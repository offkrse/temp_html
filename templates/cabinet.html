{% extends "base.html" %}
{% block content %}

<div class="settings-container">
  <div class="settings-header">
    <button class="back-btn" onclick="window.location.href='/dashboard'">‚Üê</button>
    <h3 class="settings-title">Settings</h3>
  </div>

  <h2 id="cabinet-title" style="margin-top:0.5rem;">–ö–∞–±–∏–Ω–µ—Ç</h2>
  <p id="cabinet-status">–°—Ç–∞—Ç—É—Å: <span class="status-inactive">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>

  <button id="toggle-btn" disabled>–ó–∞–≥—Ä—É–∑–∫–∞...</button>
  <button id="show-campaigns" disabled>–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π</button>
  <button id="add-campaigns" disabled>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏–∏</button>
  <button onclick="alert('‚öôÔ∏è –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ–∫–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')" disabled id="filter-btn">–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>

  <div id="campaign-list" style="margin-top:1rem; display:none; width:100%;">
    <h4>–°–ø–∏—Å–æ–∫ –∫–∞–º–ø–∞–Ω–∏–π:</h4>
    <pre id="campaigns-box" style="white-space:pre-wrap; background:rgba(255,255,255,0.05); padding:0.6rem; border-radius:8px;"></pre>
  </div>

  <div id="add-campaign-form" style="margin-top:1rem; display:none; width:100%;">
    <h4>–î–æ–±–∞–≤–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏–∏</h4>
    <textarea id="new-campaigns" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∫–∞–º–ø–∞–Ω–∏–π, –ø–æ –æ–¥–Ω–æ–º—É –≤ —Å—Ç—Ä–æ–∫–µ"></textarea>
    <button id="save-campaigns">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const tg = window.Telegram.WebApp;
  tg.expand();

  const statusEl = document.getElementById("cabinet-status");
  const uid = tg.initDataUnsafe?.user?.id;

  if (!uid) {
    statusEl.innerHTML =
      '<span style="color:#ff7777">‚ö†Ô∏è Telegram-–¥–∞–Ω–Ω—ã–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã.<br>–û—Ç–∫—Ä–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç–∞.</span>';
    return;
  }

  const cabinetId = {{ cabinet_id }};

  try {
    const res = await fetch(`/dashboard/api/cabinet/${uid}/${cabinetId}`);
    if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–±–∏–Ω–µ—Ç–∞");
    const cab = await res.json();

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
    document.getElementById("cabinet-title").innerText = cab.name;
    statusEl.innerHTML =
      "–°—Ç–∞—Ç—É—Å: " + (cab.active
        ? '<span class="status-active">üü¢ –ê–∫—Ç–∏–≤–µ–Ω</span>'
        : '<span class="status-inactive">üî¥ –û—Ç–∫–ª—é—á–µ–Ω</span>');

    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
    document.querySelectorAll("button").forEach(btn => btn.disabled = false);

    const toggleBtn = document.getElementById("toggle-btn");
    toggleBtn.innerText = cab.active ? "–í—ã–∫–ª—é—á–∏—Ç—å –∫–∞–±–∏–Ω–µ—Ç" : "–í–∫–ª—é—á–∏—Ç—å –∫–∞–±–∏–Ω–µ—Ç";
    toggleBtn.onclick = async () => {
      const resp = await fetch(`/dashboard/api/toggle/${cabinetId}`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({telegram_id: uid})
      });
      const r = await resp.json();
      alert(r.message);
      location.reload();
    };

    // –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ ‚Äî –∫–∞–∫ –±—ã–ª–æ
  } catch (err) {
    console.error(err);
    statusEl.innerHTML =
      '<span style="color:#ff7777">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫–∞–±–∏–Ω–µ—Ç–∞</span>';
  }
});
</script>

{% endblock %}
