{% extends "base.html" %}
{% block content %}

<div class="settings-container">
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
  <div class="cabinet-header">
    <button class="back-btn" onclick="window.location.href='/dashboard'">‚Üê</button>
    <h2 id="cabinet-title">–ö–∞–±–∏–Ω–µ—Ç</h2>
  </div>

  <p id="cabinet-status">–°—Ç–∞—Ç—É—Å: <span class="status-inactive">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>

  <h3 class="settings-title">Settings</h3>

  <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ -->
  <button id="toggle-btn" disabled>–ó–∞–≥—Ä—É–∑–∫–∞...</button>
  <button id="show-campaigns" disabled>–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π</button>
  <button id="add-campaigns" disabled>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏–∏</button>
  <button id="filter-btn" disabled>–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>

  <!-- –°–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π -->
  <div id="campaign-list" style="margin-top:1rem; display:none; width:100%;">
    <h4>–°–ø–∏—Å–æ–∫ –∫–∞–º–ø–∞–Ω–∏–π:</h4>
    <pre id="campaigns-box"
         style="white-space:pre-wrap; background:rgba(255,255,255,0.05);
                padding:0.6rem; border-radius:8px;"></pre>
  </div>

  <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞–º–ø–∞–Ω–∏–π -->
  <div id="add-campaign-form" style="margin-top:1rem; display:none; width:100%;">
    <h4>–î–æ–±–∞–≤–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏–∏</h4>
    <textarea id="new-campaigns" rows="4"
              placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∫–∞–º–ø–∞–Ω–∏–π, –ø–æ –æ–¥–Ω–æ–º—É –≤ —Å—Ç—Ä–æ–∫–µ"></textarea>
    <button id="save-campaigns">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>

  <!-- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ -->
  <div id="filter-section" style="margin-top:1rem; display:none; width:100%;">
    <h4>–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</h4>
    <div id="filter-box">
      <div><b>–û—Ç–∫–ª—é—á–∞—Ç—å –µ—Å–ª–∏:</b></div>
    
      <div class="filter-row">
        –ï—Å–ª–∏ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ&nbsp; 
        <span class="glass-input">
          <input id="spent_zero_result" type="number">
        </span> ‚ÇΩ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç = 0
      </div>
      
      <div class="filter-row">
        –ï—Å–ª–∏ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ&nbsp; 
        <span class="glass-input">
          <input id="spent_zero_clicks" type="number">
        </span> ‚ÇΩ –∏ –∫–ª–∏–∫–æ–≤ = 0
      </div>
      
      <div class="filter-row">
        –ï—Å–ª–∏ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ&nbsp; 
        <span class="glass-input">
          <input id="min_spent_for_cpa" type="number">
        </span> ‚ÇΩ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç =&nbsp; 
        <span class="glass-input">
          <input id="cpa_bad_value" type="number">
        </span>
      </div>
      
      <div class="filter-row">
        –ï—Å–ª–∏ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ&nbsp;
        <span class="glass-input">
          <input id="min_spent_for_cpc" type="number">
        </span> ‚ÇΩ –∏ –∫–ª–∏–∫–æ–≤ =&nbsp; 
        <span class="glass-input">
          <input id="cpc_bad_value" type="number">
        </span>
      </div>


    <button id="save-filter" style="margin-top:0.6rem;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>

</div>

<!-- === –õ–û–ì–ò–ö–ê === -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
  const tg = window.Telegram.WebApp;
  tg.expand();

  const uid = tg.initDataUnsafe?.user?.id;
  const statusEl = document.getElementById("cabinet-status");
  const cabinetId = {{ cabinet_id }};

  if (!uid) {
    statusEl.innerHTML =
      '<span style="color:#ff7777">‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö Telegram.<br>–û—Ç–∫—Ä–æ–π Mini App —á–µ—Ä–µ–∑ –±–æ—Ç–∞, –∞ –Ω–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</span>';
    return;
  }

  try {
    // === –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–±–∏–Ω–µ—Ç–∞ ===
    const res = await fetch(`/dashboard/api/cabinet/${uid}/${cabinetId}`);
    if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–±–∏–Ω–µ—Ç–∞");
    const cab = await res.json();

    // === –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Å—Ç–∞—Ç—É—Å ===
    document.getElementById("cabinet-title").innerText = cab.name;
    statusEl.innerHTML =
      "–°—Ç–∞—Ç—É—Å: " + (cab.active
        ? '<span class="status-active">üü¢ –ê–∫—Ç–∏–≤–µ–Ω</span>'
        : '<span class="status-inactive">üî¥ –û—Ç–∫–ª—é—á–µ–Ω</span>');

    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
    document.querySelectorAll("button").forEach(b => b.disabled = false);

    // === –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ ===
    const toggleBtn = document.getElementById("toggle-btn");
    toggleBtn.innerText = cab.active ? "–í—ã–∫–ª—é—á–∏—Ç—å –∫–∞–±–∏–Ω–µ—Ç" : "–í–∫–ª—é—á–∏—Ç—å –∫–∞–±–∏–Ω–µ—Ç";
    toggleBtn.onclick = async () => {
      const resp = await fetch(`/dashboard/api/toggle/${cabinetId}`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({telegram_id: uid})
      });
      const r = await resp.json();
      alert(r.message);
      location.reload();
    };

    // === –ü–æ–∫–∞–∑–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏–∏ ===
    const showBtn = document.getElementById("show-campaigns");
    showBtn.onclick = async () => {
      const box = document.getElementById("campaign-list");
      const pre = document.getElementById("campaigns-box");
      if (box.style.display === "none") {
        const r = await fetch(`/dashboard/api/cabinet_campaigns/${uid}/${cabinetId}`);
        const data = await r.json();
        pre.textContent = data.campaigns.length
          ? data.campaigns.join("\n")
          : "–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π.";
        box.style.display = "block";
      } else {
        box.style.display = "none";
      }
    };

    // === –î–æ–±–∞–≤–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏–∏ ===
    const addBtn = document.getElementById("add-campaigns");
    addBtn.onclick = () => {
      document.getElementById("campaign-list").style.display = "none";
      const form = document.getElementById("add-campaign-form");
      form.style.display = form.style.display === "none" ? "block" : "none";
    };

    document.getElementById("save-campaigns").onclick = async () => {
      const textarea = document.getElementById("new-campaigns");
      const text = textarea.value.trim();
      if (!text) return alert("–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω ID –∫–∞–º–ø–∞–Ω–∏–∏.");
      
      const list = text.split(/\n+/).map(x => x.trim()).filter(Boolean);
    
      try {
        const resp = await fetch(`/dashboard/api/add_campaigns/${uid}/${cabinetId}`, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ campaigns: list })
        });
        const data = await resp.json();
    
        // alert –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ –≤–∏–∑—É–∞–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫
        tg.HapticFeedback.notificationOccurred("success");
        const msg = data.message || "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ";
        console.log(msg);
    
        // –¥–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ–¥ –ø–æ–ª–µ–º –≤–º–µ—Å—Ç–æ alert
        let notif = document.getElementById("campaign-notif");
        if (!notif) {
          notif = document.createElement("div");
          notif.id = "campaign-notif";
          notif.style.cssText = "margin-top:6px;font-size:0.9rem;opacity:0.8;";
          textarea.parentNode.appendChild(notif);
        }
        notif.textContent = msg;
        setTimeout(() => (notif.textContent = ""), 2500);
    
        // –æ—á–∏—â–∞–µ–º –ø–æ–ª–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–æ–∫—É—Å
        textarea.value = "";
        setTimeout(() => textarea.focus(), 200);
    
        // –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π
        const r = await fetch(`/dashboard/api/cabinet_campaigns/${uid}/${cabinetId}`);
        const result = await r.json();
        const pre = document.getElementById("campaigns-box");
        if (result.campaigns.length) {
          pre.textContent = result.campaigns.join("\n");
          document.getElementById("campaign-list").style.display = "block";
        }
      } catch (e) {
        tg.HapticFeedback.notificationOccurred("error");
        console.error(e);
      }
    };


    // === –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä ===
    const filterBtn = document.getElementById("filter-btn");
    filterBtn.onclick = () => {
      const section = document.getElementById("filter-section");
      section.style.display = section.style.display === "none" ? "block" : "none";

      if (section.dataset.loaded !== "true") {
        const f = cab.filter || {};
        document.getElementById("spent_zero_result").value = f.spent_zero_result ?? 0;
        document.getElementById("spent_zero_clicks").value = f.spent_zero_clicks ?? 0;
        document.getElementById("min_spent_for_cpa").value = f.min_spent_for_cpa ?? 0;
        document.getElementById("cpa_bad_value").value = f.cpa_bad_value ?? 0;
        document.getElementById("min_spent_for_cpc").value = f.min_spent_for_cpc ?? 0;
        document.getElementById("cpc_bad_value").value = f.cpc_bad_value ?? 0;
        section.dataset.loaded = "true";
      }
    };

    // === –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä ===
    document.getElementById("save-filter").onclick = async () => {
      const newFilter = {
        spent_zero_result: +document.getElementById("spent_zero_result").value,
        spent_zero_clicks: +document.getElementById("spent_zero_clicks").value,
        min_spent_for_cpa: +document.getElementById("min_spent_for_cpa").value,
        cpa_bad_value: +document.getElementById("cpa_bad_value").value,
        min_spent_for_cpc: +document.getElementById("min_spent_for_cpc").value,
        cpc_bad_value: +document.getElementById("cpc_bad_value").value
      };

      try {
        const resp = await fetch(`/dashboard/api/update_filter/${uid}/${cabinetId}`, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ filter: newFilter })
        });
        const data = await resp.json();
        alert(data.message || "–§–∏–ª—å—Ç—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
      } catch (e) {
        alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞");
        console.error(e);
      }
    };

  } catch (e) {
    console.error(e);
    statusEl.innerHTML =
      '<span style="color:#ff7777">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –∫–∞–±–∏–Ω–µ—Ç–∞.</span>';
  }
});
</script>

{% endblock %}
