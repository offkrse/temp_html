{% extends "base.html" %}
{% block content %}

<h2 id="cabinet-title">–ö–∞–±–∏–Ω–µ—Ç</h2>
<p id="cabinet-status">–°—Ç–∞—Ç—É—Å: <span class="status-inactive">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>

<div class="settings-container">
  <div class="settings-title">Settings</div>
  
  <button id="toggle-btn">–ó–∞–≥—Ä—É–∑–∫–∞...</button>
  <button id="show-campaigns">–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π</button>
  <button id="add-campaigns">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏–∏</button>
  <button onclick="alert('‚öôÔ∏è –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ–∫–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')">–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>

  <div id="campaign-list" style="margin-top:1rem; display:none; width:100%;">
    <h4>–°–ø–∏—Å–æ–∫ –∫–∞–º–ø–∞–Ω–∏–π:</h4>
    <pre id="campaigns-box" style="white-space:pre-wrap; background:rgba(255,255,255,0.05); padding:0.6rem; border-radius:8px;"></pre>
  </div>

  <div id="add-campaign-form" style="margin-top:1rem; display:none; width:100%;">
    <h4>–î–æ–±–∞–≤–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏–∏</h4>
    <textarea id="new-campaigns" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∫–∞–º–ø–∞–Ω–∏–π, –ø–æ –æ–¥–Ω–æ–º—É –≤ —Å—Ç—Ä–æ–∫–µ"></textarea>
    <button id="save-campaigns">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div>

<script>
const cabinetId = {{ cabinet_id }};
const tg = window.Telegram.WebApp;
tg.expand();

(async () => {
  const user = tg.initDataUnsafe?.user;
  if (!user) {
    alert("‚ö†Ô∏è –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ –≤–Ω–µ Telegram");
    return;
  }

  // --- –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–±–∏–Ω–µ—Ç–∞ ---
  const res = await fetch(`/dashboard/api/cabinet/${user.id}/${cabinetId}`);
  const cab = await res.json();

  // --- –ù–∞–∑–≤–∞–Ω–∏–µ –∏ —Å—Ç–∞—Ç—É—Å ---
  document.getElementById("cabinet-title").innerText = cab.name;
  document.getElementById("cabinet-status").innerHTML =
    "–°—Ç–∞—Ç—É—Å: " + (cab.active
      ? '<span class="status-active">üü¢ –ê–∫—Ç–∏–≤–µ–Ω</span>'
      : '<span class="status-inactive">üî¥ –û—Ç–∫–ª—é—á–µ–Ω</span>');

  // --- –ö–Ω–æ–ø–∫–∞ –≤–∫–ª/–≤—ã–∫–ª ---
  const toggleBtn = document.getElementById("toggle-btn");
  toggleBtn.innerText = cab.active ? "–í—ã–∫–ª—é—á–∏—Ç—å –∫–∞–±–∏–Ω–µ—Ç" : "–í–∫–ª—é—á–∏—Ç—å –∫–∞–±–∏–Ω–µ—Ç";
  toggleBtn.onclick = async () => {
    const resp = await fetch(`/dashboard/api/toggle/${cabinetId}`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({telegram_id: user.id})
    });
    const r = await resp.json();
    alert(r.message);
    location.reload();
  };

  // --- –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π ---
  document.getElementById("show-campaigns").onclick = async () => {
    const box = document.getElementById("campaign-list");
    const pre = document.getElementById("campaigns-box");
    if (box.style.display === "none") {
      const r = await fetch(`/dashboard/api/cabinet_campaigns/${user.id}/${cabinetId}`);
      const data = await r.json();
      pre.textContent = data.campaigns.length
        ? data.campaigns.join("\n")
        : "–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π.";
      box.style.display = "block";
    } else {
      box.style.display = "none";
    }
  };

  // --- –î–æ–±–∞–≤–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏–∏ ---
  document.getElementById("add-campaigns").onclick = () => {
    const form = document.getElementById("add-campaign-form");
    form.style.display = form.style.display === "none" ? "block" : "none";
  };

  document.getElementById("save-campaigns").onclick = async () => {
    const text = document.getElementById("new-campaigns").value.trim();
    if (!text) return alert("–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω ID –∫–∞–º–ø–∞–Ω–∏–∏.");
    const list = text.split(/\n+/).map(x => x.trim()).filter(Boolean);

    const resp = await fetch(`/dashboard/api/add_campaigns/${user.id}/${cabinetId}`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({campaigns: list})
    });
    const data = await resp.json();
    alert(data.message || "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
    document.getElementById("new-campaigns").value = "";
    document.getElementById("add-campaign-form").style.display = "none";
  };
})();
</script>

{% endblock %}
