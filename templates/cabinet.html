{% extends "base.html" %}
{% block content %}

<div class="settings-container">
  <div class="settings-header">
    <button class="back-btn" onclick="window.location.href='/dashboard'">‚Üê</button>
    <h3 class="settings-title">Settings</h3>
  </div>

  <h2 id="cabinet-title" style="margin-top:0.5rem;">–ö–∞–±–∏–Ω–µ—Ç</h2>
  <p id="cabinet-status">–°—Ç–∞—Ç—É—Å: <span class="status-inactive">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>

  <button id="toggle-btn" disabled>–ó–∞–≥—Ä—É–∑–∫–∞...</button>
  <button id="show-campaigns" disabled>–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π</button>
  <button id="add-campaigns" disabled>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏–∏</button>
  <button id="filter-btn" disabled>–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>

  <div id="campaign-list" style="margin-top:1rem; display:none; width:100%;">
    <h4>–°–ø–∏—Å–æ–∫ –∫–∞–º–ø–∞–Ω–∏–π:</h4>
    <pre id="campaigns-box"
         style="white-space:pre-wrap; background:rgba(255,255,255,0.05);
                padding:0.6rem; border-radius:8px;"></pre>
  </div>

  <div id="add-campaign-form" style="margin-top:1rem; display:none; width:100%;">
    <h4>–î–æ–±–∞–≤–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏–∏</h4>
    <textarea id="new-campaigns" rows="4"
              placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∫–∞–º–ø–∞–Ω–∏–π, –ø–æ –æ–¥–Ω–æ–º—É –≤ —Å—Ç—Ä–æ–∫–µ"></textarea>
    <button id="save-campaigns">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
  const tg = window.Telegram.WebApp;
  tg.expand();

  const uid = tg.initDataUnsafe?.user?.id;
  const statusEl = document.getElementById("cabinet-status");
  const cabinetId = {{ cabinet_id }};

  if (!uid) {
    statusEl.innerHTML =
      '<span style="color:#ff7777">‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö Telegram.<br>–û—Ç–∫—Ä–æ–π Mini App —á–µ—Ä–µ–∑ –±–æ—Ç–∞, –∞ –Ω–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</span>';
    return;
  }

  try {
    const res = await fetch(`/dashboard/api/cabinet/${uid}/${cabinetId}`);
    if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–±–∏–Ω–µ—Ç–∞");
    const cab = await res.json();

    document.getElementById("cabinet-title").innerText = cab.name;
    statusEl.innerHTML =
      "–°—Ç–∞—Ç—É—Å: " + (cab.active
        ? '<span class="status-active">üü¢ –ê–∫—Ç–∏–≤–µ–Ω</span>'
        : '<span class="status-inactive">üî¥ –û—Ç–∫–ª—é—á–µ–Ω</span>');

    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
    document.querySelectorAll("button").forEach(b => b.disabled = false);

    // === –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ ===
    const toggleBtn = document.getElementById("toggle-btn");
    toggleBtn.innerText = cab.active ? "–í—ã–∫–ª—é—á–∏—Ç—å –∫–∞–±–∏–Ω–µ—Ç" : "–í–∫–ª—é—á–∏—Ç—å –∫–∞–±–∏–Ω–µ—Ç";
    toggleBtn.onclick = async () => {
      const resp = await fetch(`/dashboard/api/toggle/${cabinetId}`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({telegram_id: uid})
      });
      const r = await resp.json();
      alert(r.message);
      location.reload();
    };

    // === –ü–æ–∫–∞–∑–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏–∏ ===
    const showBtn = document.getElementById("show-campaigns");
    showBtn.onclick = async () => {
      const box = document.getElementById("campaign-list");
      const pre = document.getElementById("campaigns-box");
      if (box.style.display === "none") {
        const r = await fetch(`/dashboard/api/cabinet_campaigns/${uid}/${cabinetId}`);
        const data = await r.json();
        pre.textContent = data.campaigns.length
          ? data.campaigns.join("\n")
          : "–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π.";
        box.style.display = "block";
      } else {
        box.style.display = "none";
      }
    };

    // === –î–æ–±–∞–≤–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏–∏ ===
    const addBtn = document.getElementById("add-campaigns");
    addBtn.onclick = () => {
      const form = document.getElementById("add-campaign-form");
      form.style.display = form.style.display === "none" ? "block" : "none";
    };

    document.getElementById("save-campaigns").onclick = async () => {
      const text = document.getElementById("new-campaigns").value.trim();
      if (!text) return alert("–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω ID –∫–∞–º–ø–∞–Ω–∏–∏.");
      const list = text.split(/\n+/).map(x => x.trim()).filter(Boolean);

      const resp = await fetch(`/dashboard/api/add_campaigns/${uid}/${cabinetId}`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({campaigns: list})
      });
      const data = await resp.json();
      alert(data.message || "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
      document.getElementById("new-campaigns").value = "";
      document.getElementById("add-campaign-form").style.display = "none";
    };

  } catch (e) {
    console.error(e);
    statusEl.innerHTML =
      '<span style="color:#ff7777">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –∫–∞–±–∏–Ω–µ—Ç–∞.</span>';
  }
});
</script>

{% endblock %}
